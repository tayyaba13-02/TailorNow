@model IEnumerable<TailorrNow.Models.ViewModels.BookingViewModel>
@{
    ViewBag.Title = "View Bookings - TailorNow";
    Layout = "~/Views/Shared/_LayoutTailor.cshtml";
}

<div class="container-fluid py-4" style="min-height: 80vh;">
    @Html.AntiForgeryToken()
   
    <div class="bg-primary text-white rounded-3 p-4 mb-4 shadow">
        <div class="d-flex justify-content-between align-items-center">
            <div>
                <h2 class="fw-bold mb-1"><i class="bi bi-calendar-check me-2"></i>Customer Bookings</h2>
                <p class="mb-0">Manage all your tailoring appointments</p>
            </div>
        </div>
    </div>

    
    <form method="get" asp-action="ViewBookings" class="card mb-4 border-0 shadow-sm">
        <div class="card-body py-3">
            <div class="row g-3 align-items-end">
                <div class="col-md-3 col-6">
                    <label class="form-label small text-muted mb-1">Status</label>
                    <select class="form-select" name="status" id="statusFilter">
                        <option value="all" selected="@(ViewBag.StatusFilter == "all")">All Statuses</option>
                        <option value="pending" selected="@(ViewBag.StatusFilter == "pending")">Pending</option>
                        <option value="confirmed" selected="@(ViewBag.StatusFilter == "confirmed")">Confirmed</option>
                        <option value="completed" selected="@(ViewBag.StatusFilter == "completed")">Completed</option>
                        <option value="cancelled" selected="@(ViewBag.StatusFilter == "cancelled")">Cancelled</option>
                    </select>
                </div>
                <div class="col-md-3 col-6">
                    <label class="form-label small text-muted mb-1">Date</label>
                    <input type="date" class="form-control" name="date" id="dateFilter" value="@ViewBag.DateFilter">
                </div>
                <div class="col-md-4 col-8">
                    <label class="form-label small text-muted mb-1">Search</label>
                    <input type="text" class="form-control" name="search" placeholder="Customer name or service..."
                           id="searchFilter" value="@ViewBag.SearchFilter">
                </div>
                <div class="col-md-1 col-4">
                    <button type="submit" class="btn btn-primary w-100">
                        <i class="bi bi-funnel me-1"></i> Filter
                    </button>
                </div>
                <div class="col-md-1 col-12">
                    <a asp-action="ViewBookings" class="btn btn-outline-secondary w-100">
                        <i class="bi bi-x-circle me-1"></i> Clear
                    </a>
                </div>
            </div>
        </div>
    </form>

  
    <div class="row g-4">
        @foreach (var item in Model)
        {
            <div class="col-md-6 col-lg-4">
                <div class="card border-start border-4 @GetStatusBorderClass(item.Booking.Status) shadow-sm h-100">
                    <div class="card-body">
                        <div class="d-flex justify-content-between align-items-start mb-3">
                            <div>
                                <h5 class="fw-bold mb-1">@item.Booking.Customer?.FullName</h5>
                                <small class="text-muted">@item.CustomerType</small>
                            </div>
                            <span class="badge @GetStatusBadgeClass(item.Booking.Status)">@item.Booking.Status</span>
                        </div>

                        <div class="d-flex align-items-center mb-3">
                            <div class="avatar-circle bg-primary text-white me-3">
                                @GetInitials(item.Booking.Customer?.FullName)
                            </div>
                            <div>
                                <h6 class="mb-0">@item.Booking.Service?.ServiceName</h6>
                                <small class="text-muted">@item.Booking.Notes</small>
                            </div>
                        </div>

                        <div class="mb-3">
                            <div class="d-flex justify-content-between mb-1">
                                <span class="text-muted">Date/Time</span>
                                <span>@item.Booking.BookingDate.ToString("MMM d, yyyy · h:mm tt")</span>
                            </div>
                            <div class="d-flex justify-content-between">
                                <span class="text-muted">Amount</span>
                                <span class="fw-bold">₹@item.Booking.Service?.Price</span>
                            </div>
                        </div>

                        <div class="d-flex justify-content-end">
                            @if (item.Booking.Status == "Pending")
                            {
                                <button class="btn btn-sm btn-outline-danger me-2"
                                        onclick="updateBookingStatus(@item.Booking.Id, 'cancelled')">
                                    Decline
                                </button>
                                <button class="btn btn-sm btn-primary"
                                        onclick="updateBookingStatus(@item.Booking.Id, 'confirmed')">
                                    Accept
                                </button>
                            }
                            else if (item.Booking.Status == "Confirmed")
                            {
                                <button class="btn btn-sm btn-primary"
                                        onclick="updateBookingStatus(@item.Booking.Id, 'completed')">
                                    Mark as Completed
                                </button>
                            }
                            else if (item.Booking.Status == "Cancelled")
                            {
                                <button class="btn btn-sm btn-outline-primary"
                                        onclick="updateBookingStatus(@item.Booking.Id, 'pending')">
                                    Re-activate
                                </button>
                            }
                        </div>
                    </div>
                </div>
            </div>
        }
    </div>
</div>

@section Scripts {
    <script>
        function updateBookingStatus(bookingId, status) {
            fetch('/Tailor/UpdateBookingStatus', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'RequestVerificationToken': document.querySelector('input[name="__RequestVerificationToken"]').value
                },
                body: JSON.stringify({
                    bookingId: bookingId,
                    status: status
                })
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    location.reload();
                } else {
                    alert('Failed to update booking status');
                }
            });
        }
    </script>
}

@functions {
    string GetStatusBorderClass(string status)
    {
        return status.ToLower() switch
        {
            "pending" => "border-warning",
            "confirmed" => "border-success",
            "completed" => "border-primary",
            "cancelled" => "border-danger",
            _ => "border-secondary"
        };
    }

    string GetStatusBadgeClass(string status)
    {
        return status.ToLower() switch
        {
            "pending" => "bg-warning text-dark",
            "confirmed" => "bg-success",
            "completed" => "bg-primary",
            "cancelled" => "bg-danger",
            _ => "bg-secondary"
        };
    }

    string GetInitials(string fullName)
    {
        if (string.IsNullOrEmpty(fullName)) return "??";
        var names = fullName.Split(' ');
        return names.Length >= 2
            ? $"{names[0][0]}{names[1][0]}".ToUpper()
            : names[0].Length >= 2
                ? names[0].Substring(0, 2).ToUpper()
                : names[0].ToUpper();
    }
}