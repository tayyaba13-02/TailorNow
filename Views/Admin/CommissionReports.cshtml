@{
    ViewBag.Title = "Commission Reports - TailorNow Admin";
    Layout = "~/Views/Shared/_AdminLayout.cshtml";
    var tailorEarningsRaw = ViewBag.TailorEarnings as IEnumerable<dynamic>;
    decimal totalRevenue = 0;
    decimal totalCommission = 0;
    int activeTailorsCount = tailorEarningsRaw?.Count() ?? 0;

    if (tailorEarningsRaw != null)
    {
        foreach (var item in tailorEarningsRaw)
        {
            totalCommission += (decimal)item.Commission;
            totalRevenue += (decimal)item.Commission * 10;
        }
    }
}

<div class="container-fluid px-0">
    
    <!-- Hero Header -->
    <div class="bg-primary text-white py-5 shadow-sm mb-4">
        <div class="container text-center reveal active">
            <h2 class="fw-bold mb-2"><i class="bi bi-graph-up-arrow me-2"></i>Commission Reports</h2>
            <p class="mb-0 opacity-75">Track platform earnings and tailor-wise commission distributions</p>
        </div>
    </div>

    <div class="container py-2">
        <!-- Summary Cards -->
        <div class="row g-4 mb-4">
            <div class="col-md-4 reveal active">
                <div class="feature-card text-center border-0 shadow-sm h-100 p-4">
                    <div class="icon-box bg-success-light text-success mx-auto mb-3">
                        <i class="bi bi-cash-stack fs-3"></i>
                    </div>
                    <h3 class="fw-bold text-dark">@totalRevenue.ToString("C2")</h3>
                    <p class="text-muted mb-0">Total Platform Revenue</p>
                </div>
            </div>
            <div class="col-md-4 reveal active">
                <div class="feature-card text-center border-0 shadow-sm h-100 p-4">
                    <div class="icon-box bg-warning-light text-warning mx-auto mb-3">
                        <i class="bi bi-percent fs-3"></i>
                    </div>
                    <h3 class="fw-bold text-dark">@totalCommission.ToString("C2")</h3>
                    <p class="text-muted mb-0">Total Platform Commission</p>
                </div>
            </div>
            <div class="col-md-4 reveal active">
                <div class="feature-card text-center border-0 shadow-sm h-100 p-4">
                    <div class="icon-box bg-info-light text-info mx-auto mb-3">
                        <i class="bi bi-people fs-3"></i>
                    </div>
                    <h3 class="fw-bold text-dark">@activeTailorsCount</h3>
                    <p class="text-muted mb-0">Tailors with Earnings</p>
                </div>
            </div>
        </div>

        <!-- Filter Card -->
        <div class="card border-0 shadow-sm rounded-4 mb-4 reveal">
            <div class="card-body p-4">
                <h5 class="fw-bold text-primary mb-4"><i class="bi bi-calendar-range me-2"></i>Select Report Period</h5>
                <form method="get" action="@Url.Action("CommissionReports", "Admin")">
                    <div class="row g-3 align-items-end">
                        <div class="col-md-5">
                            <label class="form-label fw-bold small text-muted text-uppercase">Start Date</label>
                            <div class="input-group">
                                <span class="input-group-text bg-light border-end-0"><i class="bi bi-calendar-event text-primary"></i></span>
                                <input type="date" name="startDate" id="startDate" class="form-control bg-light border-start-0 ps-0" />
                            </div>
                        </div>
                        <div class="col-md-5">
                            <label class="form-label fw-bold small text-muted text-uppercase">End Date</label>
                            <div class="input-group">
                                <span class="input-group-text bg-light border-end-0"><i class="bi bi-calendar-check text-primary"></i></span>
                                <input type="date" name="endDate" id="endDate" class="form-control bg-light border-start-0 ps-0" />
                            </div>
                        </div>
                        <div class="col-md-2">
                            <button type="submit" class="btn btn-primary w-100 rounded-pill shadow-sm py-2">
                                Apply
                            </button>
                        </div>
                    </div>
                </form>
            </div>
        </div>

        <!-- Detailed Report Table -->
        <div class="card border-0 shadow-lg rounded-4 overflow-hidden reveal active">
            <div class="card-body p-4">
                <div class="d-flex justify-content-between align-items-center mb-4">
                    <h5 class="fw-bold text-dark mb-0"><i class="bi bi-list-stars me-2 text-primary"></i>Earnings by Tailor</h5>
                    <button class="btn btn-outline-primary btn-sm rounded-pill px-3">
                        <i class="bi bi-download me-1"></i> Export CSV
                    </button>
                </div>
                <div class="table-responsive">
                    <table class="table table-hover align-middle mb-0">
                        <thead class="bg-light">
                            <tr>
                                <th class="ps-4 py-3 text-uppercase small fw-bold text-muted">Tailor Name</th>
                                <th class="py-3 text-uppercase small fw-bold text-muted">Total Bookings</th>
                                <th class="py-3 text-uppercase small fw-bold text-muted">Total Revenue</th>
                                <th class="py-3 text-uppercase small fw-bold text-muted">Platform Commission (10%)</th>
                                <th class="text-end pe-4 py-3 text-uppercase small fw-bold text-muted">Net Earnings</th>
                            </tr>
                        </thead>
                        <tbody class="border-top-0">
                            @if (tailorEarningsRaw != null && tailorEarningsRaw.Any())
                            {
                                foreach (var item in tailorEarningsRaw)
                                {
                                    decimal revenue = (decimal)item.Commission * 10;
                                    decimal commission = (decimal)item.Commission;
                                    decimal net = revenue - commission;
                                    <tr>
                                        <td class="ps-4">
                                            <div class="d-flex align-items-center">
                                                <div class="avatar-circle bg-primary-light text-primary me-2">
                                                    @item.TailorName.Substring(0, 1)
                                                </div>
                                                <span class="fw-bold">@item.TailorName</span>
                                            </div>
                                        </td>
                                        <td>@item.TotalBookings</td>
                                        <td>@revenue.ToString("C2")</td>
                                        <td>@commission.ToString("C2")</td>
                                        <td class="text-end pe-4 fw-bold text-success">@net.ToString("C2")</td>
                                    </tr>
                                }
                            }
                            else
                            {
                                <tr>
                                    <td colspan="5" class="text-center py-5 text-muted">No earning data available.</td>
                                </tr>
                            }
                        </tbody>
                        <tfoot class="bg-light fw-bold">
                            <tr>
                                <td class="ps-4 py-3">GRAND TOTAL</td>
                                <td>-</td>
                                <td>@totalRevenue.ToString("C2")</td>
                                <td>@totalCommission.ToString("C2")</td>
                                <td class="text-end pe-4 text-primary">@((totalRevenue - totalCommission).ToString("C2"))</td>
                            </tr>
                        </tfoot>
                    </table>
                </div>
            </div>
        </div>
    </div>
</div>

@section Scripts {
    <script>
        function reveal() {
            var reveals = document.querySelectorAll(".reveal");
            for (var i = 0; i < reveals.length; i++) {
                var windowHeight = window.innerHeight;
                var elementTop = reveals[i].getBoundingClientRect().top;
                if (elementTop < windowHeight - 100) {
                    reveals[i].classList.add("active");
                }
            }
        }
        window.addEventListener("scroll", reveal);
        document.addEventListener("DOMContentLoaded", reveal);
    </script>
}
